use std::ops;

#[derive(Clone, Debug, PartialEq)]
enum Tile {
	Empty,
	Obstacle,
	Visited,
	Start,
}

impl From<u8> for Tile {
	fn from(value: u8) -> Self {
		match value {
			b'.' => Self::Empty,
			b'#' => Self::Obstacle,
			b'X' => Self::Visited,
			b'^' => Self::Start,
			other => panic!("invalid char: {other}"),
		}
	}
}

impl From<Tile> for u8 {
	fn from(val: Tile) -> Self {
		match val {
			Tile::Empty => b'.',
			Tile::Obstacle => b'#',
			Tile::Visited => b'X',
			Tile::Start => b'^',
		}
	}
}

// todo: convert to struct with 1D tile Vec and size Vec2
#[derive(Clone, Debug)]
struct Map(Vec<Vec<Tile>>);

impl From<&str> for Map {
	fn from(value: &str) -> Self {
		Self(
			value
				.trim()
				.lines()
				.map(|line| line.bytes().map(Tile::from).collect())
				.collect(),
		)
	}
}

impl From<&Map> for String {
	fn from(map: &Map) -> Self {
		map.clone()
			.0
			.into_iter()
			.map(|row| {
				row.into_iter()
					.map(|tile| u8::from(tile) as char)
					.collect::<String>()
			})
			.collect::<Vec<_>>()
			.join("\n")
	}
}

impl Map {
	fn is_in_range(&self, pos: &Vec2) -> bool {
		let Vec2(x, y) = *pos;
		x >= 0 && y >= 0 && y < self.0.len() as i32 && x < self.0[0].len() as i32
	}

	fn at(&self, pos: &Vec2) -> Option<&Tile> {
		if self.is_in_range(pos) {
			let Vec2(x, y) = *pos;
			Some(&self.0[y as usize][x as usize])
		} else {
			None
		}
	}

	fn set_at(&mut self, pos: &Vec2, tile: Tile) {
		if self.is_in_range(pos) {
			let Vec2(x, y) = *pos;
			self.0[y as usize][x as usize] = tile;
		} else {
			panic!("map index is out of range: {:?} = {:?}", pos, tile)
		}
	}

	fn count(&self, target: &Tile) -> usize {
		self.0
			.iter()
			.map(|row| row.iter().filter(|tile| *tile == target).count())
			.sum()
	}

	fn find_start(&self) -> Vec2 {
		let mut pos = Vec2::default();
		for row in &self.0 {
			for tile in row {
				if *tile == Tile::Start {
					return pos;
				}
				pos = pos + Vec2(1, 0)
			}
			pos.0 = 0;
			pos = pos + Vec2(0, 1)
		}
		panic!("map needs a Start tile");
	}
}

// todo: convert to struct with X and Y
#[derive(Debug, Default, Copy, Clone)]
struct Vec2(i32, i32);

impl ops::Add<Vec2> for Vec2 {
	type Output = Vec2;

	fn add(self, other: Vec2) -> Self::Output {
		Vec2(self.0 + other.0, self.1 + other.1)
	}
}

const DIRECTIONS: [Vec2; 4] = [Vec2(0, -1), Vec2(1, 0), Vec2(0, 1), Vec2(-1, 0)];

pub fn part1() -> usize {
	let mut map = Map::from(INPUT);
	let mut pos = map.find_start();
	map.set_at(&pos, Tile::Visited);

	let dirs = DIRECTIONS;
	let mut dir_i = 0;
	let mut dir_l = DIRECTIONS.len();

	loop {
		map.set_at(&pos, Tile::Visited);

		let dir = dirs[dir_i];
		let next_pos = pos + dir;

		println!("{}\n", String::from(&map));

		if let Some(next_tile) = map.at(&next_pos) {
			if *next_tile == Tile::Obstacle {
				dir_i += 1;
				dir_i %= dir_l;
			} else {
				pos = next_pos;
			}
		} else {
			break;
		}
	}

	map.count(&Tile::Visited)
}

pub fn part2() -> usize {
	todo!()
}

const INPUT: &str = PROD_INPUT;

const TEST_INPUT: &str = "
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
";

const PROD_INPUT: &str = "
..........#..........#.#.......................................................................#...............#......#...#.......
........................................#..#..........#.........#..#..............................................................
.........#.......................................................................................................#................
..................................#.#..................................#..#.......#.....#.#............#.#........................
...#.......................................................#.........#...................#.................#......................
...............#.........#...........#................................................#..............#...........#.............#..
...................#..#..................................................................#........................................
........##..............................##................................#.....................#...#.............................
................................#...................#...........#.#...........................................................#...
......#......#...........................................#............................................#...#..#....#...............
............................#...#......#.....#.........#...#..#..............#....#...................#.........................#.
....................##.#........#.........#.............#......................#.#....#..............#........................#..#
#....................#......#..........#................................................................................#.........
..............#.............................................................#..........................#........#.....#..........#
.....................#........#......##.#.........#..........#.##.......................................#....#....................
................................................................#..#...........#.........#........................................
...............#..........#..#....#.#.#..................................#................................#..................#....
...................#....#.........................................................................................................
....#........................................................#......#......#.......................................#............#.
................................................#...#...........................................................#.................
..............#............................#.#.........................................#....#.....................................
...........#....#......#..................................................................#.....#..........#.............#.#......
...........................................#........#.#.........#.................#.....#.........................................
.............#.........#.........................#......#.....................#.#.................................................
.............#.....#................#...................................................#.........................................
..#....#............#................#...........................#..................#............#................................
#............................................................#......#..................................#...............#.......#..
.........................#...#.................................................................#..#...........................#..#
.................#.......................................#...............................#...#...#............#..........#........
......................#.........#...............#......#................................#.#....#.......#..........................
.#......##.................................#.................#...#.................#............................................#.
..#..................#.....#.#......#................................#..#...#......##....#..........#..................#..........
.................................................................................#...................................#............
..............................#..#...............................#....#.............................#.......#..................#..
..........#........#.....................................#..............#.....#..#................#........#.#..................#.
....................................#....#..........#........##...................................................................
.......#............................##.......#....#................................................................#.#............
.......................#......................................................#.................#.................................
.......#...................#..................................................................................................#...
.........#.....#................................#...............#........#.....................................#................#.
..#...........................#.....#..........#............................................#........#........#.#.................
...#.........#.............................#......#......................#.......................................#.......#.......#
.........................#.........#........#....................#..................#....#...#.................#..................
...............#.....................................................#....#....^............#.....................................
.......#.......#.....#.............#...........#...#..................................#...#.#....#.........................#......
.............#....................#..................................................#.........................#..................
......................................................##..........................................................................
.....................................#.....................................................................#............#..#....#.
#......................#....................#...#..................#....#.......................................#........#........
.#.....................................................................#...........................#....................##........
............#............#.........................#.........#.....................#..#........#...............................#..
.......#..#...........................................................#..#........#................#................#.............
..............................................................................................................#...................
..#............................#.....#.............#...............#..................................................#...........
..#........#..........................................................................#...........#.....##...................#....
..#.........#...................................#.................................................................................
...#.#......................#.......#...........#.........................................................#..........#............
.............#......#............#............................................................#......#............................
..............#......#...................................................................................................#........
..............#.#............................................................................#......##............................
...........#....................#...................#......#..............#.........................#.....#...#.............#.....
.................#......#................................................................................#...............#........
..#...........................................................................................#...................................
#.............#.......................#..#.....................................#..#.....#.....................#...................
.........#..#...#......#.......#................................#..............#.........#..........................#......#......
.....##...........#................................................................................................#..........#...
.#.........#....................................................##.............................#...#.........#....................
............#...............................#.#...............................................#...............................#...
...............................#..................#...........................#..............................................#....
.#..........#....#.............#.....#.....................#.....................#...................#.........................#..
.............................................................#................##..............#...................#...............
..........................##.........#................................................................................#...........
........#..#...........................#...................................................................#......................
..#.....#...................................................................#.....#....#..#.......#.......#.....#.....#...........
....................................#.......#....#......................................#........................#...........#....
...............#..............#.................#...............#....#....................................................#.......
....#..................#..........................................................................#.......#..........#............
..#...................................................#...............#...............................#......#................#...
.......#............#............................#.......................................#...#....................##..............
...............................#.......#................................#..............#....................#.....................
...........................#..............................................#..........................................#.#..#.......
....#........#....................#...........................................................................................#...
#..................#.....................#....................................#.#............#...................#................
....#........#...#............................#...#.......................#...............#........#....#.........................
.............................................................................................#....#...............#..#............
.........#..........#...........................................................#.#........................#..................#...
.....................................#................#.........#.#..........##......................#..#.........................
.....#..#.....................................................................#.#................................##...............
...............................#....#.#..................................................#.#.........................#........#...
#.......................................##.....#..........................#..#....................#.........#..........#..........
......#.#.............#....##...................................................................#................#....#......#....
..................#...#........................................#........................................#...#.....................
....................#...#...........##...................#..#....#.............................#......#............#..............
.........#.........................................................................#..........#...................................
......................................#...................................................................#.#.#..................#
.......#...#.....#........#..............#................#.........................#.#...........#.#.............#.......#.......
...#.................#......#...........#.............#.....................................#.....................................
.#...........................................................................................................#....................
............#..........#.......................#...........................................................................#....#.
......#....#...#.........................#......#......................##....#.......#.....................#....#.................
....................................#..........................#.......#.......#......................................#........##.
...................#..................................................................................#..............#.#..........
....#..........................#.....................#.#.........#...#......#..#....#.............................................
..................#......#................#........................................#...#........#.................................
...............................#.........#..................................................#.....................................
..................#..............................................#...............#...........#..#.................................
...........................#........................................................#........#....................................
.................#.......#.........##.............#...#....#......................#.......#.......................................
...........#...............#........................................................................#.#...........................
...........#..........#..........................#.....................#....#.........#...................##...#.........#........
.......#.............#........#...........................................#.................................................#.#...
.....................#..................................#.#......#...................#.........................#...#....#..##.....
.......#...................#.............#..#..................................................................#..................
..#........#........................#............#..#...#...........................#......................................#.#....
.............................#..#.......#.........#.....................................................................##...#....
..............##................#........................#..................................................#.....#...#...........
.............#..............#......#..............................................................#...................#...........
#...#............#...........##.............#..........................................#..........................................
..........................#.....#...................#....................#................#.......................................
.....................................................#..................................................................#...#.....
..................#.#........#....#.#.#..#...............................................#.....###..#.........................#...
.#...#.........#..........#.......................................................................#.#............#............#...
...#..............................#.............................#.#............................................#..................
#................................................#..#..........................................................#...............#.#
........................................#.............#..............#...............#.........#...#..............................
..............................#.................#..................#................#.....#.......#..........#....................
............#.......#...........#.........................................................................................#.......
#.#..............................#................#.#...................#.....................#.....................#......#......
.....#..#.......##...........................................#............................#.......................................
.......#..#..#.........#..........................#.#....#..........................#...#........................#.....#..........
";
